<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />

    <title>Student Profile</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://netdna.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Font-style -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,400;0,500;0,600;0,700;1,400;1,500;1,600&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../static/eportfolio/navbar.css" />
    <link rel="stylesheet" href="../static/eportfolio/style.css" />
    <!-- link for datatables -->

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.css"
    />
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.js"></script>

    <script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.print.min.js"></script>

    <!-- end of link for datatables -->
  </head>

  <body>
    <div id="wrapper" class="wrapper-content ">
      <div id="sidebar-wrapper">
    <ul class="sidebar-nav">
<li class="sidebar-brand">
  <a class="no-hovera" href="#">
    Eportfolio
      </a>
      </li>
      <li  id="activeProfile">
        <a id="showProfilePage"> <i class="fa fa-user"></i> Profile</a>
      </li>
      <li id="activeStat">
        <a href="#" id="statisticPage">
          <i class="fa fa-calendar"></i> Statistics
        </a>
      </li>
      <li id="activeSubject" class="active">
        <a id="Subjects"> <i class="fa fa-book"></i>Subjects</a>
      </li>
      <li id="activeEdit">
        <a id="editProfile"> <i class="fa fa-edit"></i> Edit profile</a>
      </li>
      <li id="activeSignOut">
        <a id="Signout"> <i class="fa fa-sign-out"></i> Sign Out</a>
      </li>
    </ul>
    </div>
    <div class="container-fluid">
      <button class="btn-menu btn btn-toggle-menu overlay-button" type="button">
      <i class="fa fa-bars"></i>
      </button>
        </div>
    <div class="container bootstrap snippets bootdey overlay">
      <div class="row">
        <div class="profile-nav col-md-2">
        
        </div>

        <div class="profile-info col-md-10" id="profilePage">
          <div class="panel">
            <div class="bio-graph-heading">
              Welcome Back!
              <h2>{{studentprof.firstName}}</h2>
            </div>
            <div class="panel-body bio-graph-info" id="editProfileHolderReload">
              {% if studentprof %}
              <h1>Demographic Profile</h1>
              <div class="row">
                <div class="bio-row">
                  <p><span>First Name </span>: {{studentprof.firstName}}</p>
                </div>
                <div class="bio-row">
                  <p><span>Last Name </span>: {{studentprof.lastName}}</p>
                </div>
                <div class="bio-row">
                  <p>
                    <span>Student No. </span>: {{studentprof.studentNumber}}
                  </p>
                </div>
                <div class="bio-row">
                  <p>
                    <span>Year / Course</span>: {{studentprof.yearID}} /
                    {{studentprof.courseID}}
                  </p>
                </div>
                <div class="bio-row">
                  <p>
                    <span>Contact Details </span>: {{studentprof.contactNumber}}
                  </p>
                </div>
                <div class="bio-row">
                  <p>
                    <span>Email </span>:
                    <a href="/cdn-cgi/l/email-protection" class="__cf_email__"
                      >{{studentprof.emailAddress}}</a
                    >
                  </p>
                </div>
                <div class="bio-row">
                  <p>
                    <span>Guardian Name </span>: {{studentprof.guardianName}}
                  </p>
                </div>
                <div class="bio-row">
                  <p>
                    <span>Guardian No. </span>: {{studentprof.guardianNumber}}
                  </p>
                </div>
              </div>
              {% endif %}
            </div>
          </div>
          <div>
            <h2 class="sub-head">Subjects</h2>
            <div class="row" id="listOfSubs">
              {% for sub in subjects %}
              <a
                href="{% url 'studentSubject' studentprof.studentNumber sub.subjectCode %}"
              >
                <div class="col-md-6">
                  <div class="panel sub-wrapper">
                    <div class="panel-body subject-bg">
                      <div class="bio-chart"></div>
                      <div class="sub-textoverlay">
                        <h4 class="cc-text">{{sub.subjectCode}}</h4>
                        <p class="sub-text">{{sub.subjectName}}</p>
                      </div>
                    </div>
                  </div>
                </div>
              </a>
              {% endfor %}
            </div>
          </div>
        </div>

        <div class="profile-info col-md-9" id="editPage">
          <div class="panel">
            <div class="panel-body bio-graph-info">
              <h1>Edit Demographic Profile</h1>
              <div class="row">
                <div class="bio-row">
                  <label for="guardianName">Guardian Name:</label>
                  <input
                    type="text"
                    class="form-control"
                    id="guardianName"
                    name="guardianName"
                    value="{{studentprof.guardianName}}"
                  />
                </div>

                <div class="bio-row">
                  <label for="guardianNumber">Guardian Contact Details</label>
                  <input
                    type="text"
                    class="form-control"
                    id="guardianNumber"
                    name="guardianNumber"
                    value="{{studentprof.guardianNumber}}"
                  />
                </div>

                <div class="bio-row">
                  <label for="courseID">Course:</label>
                  <select class="form-control" id="courseID" name="courseID">
                    {% for course in courseList %}
                    <option value="{{course.course}}">{{course.course}}</option>
                    {% endfor %}
                  </select>
                </div>

                <div class="bio-row">
                  <label for="yearID">Year Level:</label>
                  <select class="form-control" id="yearID" name="yearID">
                    {% for year in yearList %}
                    <option value="{{year.yearLevel}}">
                      {{year.yearLevel}}
                    </option>
                    {% endfor %}
                  </select>
                </div>

                <div class="bio-row">
                  <label for="contactNumber">Contact Details</label>
                  <input
                    type="text"
                    class="form-control"
                    id="contactNumber"
                    name="contactNumber"
                    value="{{studentprof.contactNumber}}"
                  />
                </div>

                <div class="bio-row">
                  <div class="bio-row">
                    <button
                      type="button"
                      id="saveProfile"
                      class="btn btn-primary btn-hovergreen"
                      style="margin-top: 15%"
                    >
                      Save
                    </button>
                  </div>
                </div>
                <div class="bio-row">
                  <form method="post" action="/accounts/logout/">
                    {% csrf_token %}
                    <button class="btn btn-dark btn-hoverred" type="submit">
                      Sign Out
                    </button>
                  </form>
                </div>
              </div>
            </div>
          </div>
          <div class="panel-body bio-graph-info">
            <table id="example" class="display" style="width: 100%">
              <thead>
                <tr>
                  <th>Subject Code</th>
                  <th>Subject Name</th>
                  <th>Faculty</th>
                  <th>No. Of Units</th>
                  <th>ADD</th>
                </tr>
              </thead>
              {% for sub in availSubs %}
              <tbody>
                <tr>
                  <td>{{sub.subjectCode}}</td>
                  <td>{{sub.subjectName}}</td>
                  <td>{{sub.facultyName}}</td>
                  <td>{{sub.units}}</td>
                  
                  <td>
                    <button
                      type="button"
                      class="btn btn-info addSubButton"
                      value="{{sub.id}}"
                    >
                      Add Subject
                    </button>
                  </td>
                 
                </tr>
              </tbody>
              {% endfor %}

            </table>
          </div>
        </div>

        <div class="profile-info col-md-9" id="statPage">
          {% for sub in subjects %}
          <div class="panel">
            <div class="panel-body bio-graph-info">
              <h1>{{sub.subjectCode}}:{{sub.subjectName}}</h1>
              <div id="{{sub.subjectCode}}: {{sub.subjectName}}"></div>
            </div>
          </div>
          <br />

          {% endfor %}
        </div>


        <div class="profile-info col-md-9" id="subjectPage">
          <h2>Subjects</h2>
          
        </div>
      </div>
    </div>
    {% csrf_token %}
    <script>
      $(document).ready(() => {
        // getting the object from django template-------------
        const data = "{{test|safe}}";

        const validJson = data.replace(/'/g, '"');

        // Parse the string as JSON
        const obj = JSON.parse(validJson);

        for (const [key, value] of Object.entries(obj)) {
          let counter = 0;

          const subArray = Object.entries(value).map(([subKey, subValue]) => [
            subKey,
            subValue,
          ]);
          graph_it_percentage(subArray, 200, document.getElementById(key));
        }

        // getting the object from django template -------------------------------

        // edit Profile -----------------------------------------
        var course = "{{studentprof.courseID}}";
        var year = "{{studentprof.yearID}}";
        $("#courseID").val(course);
        $("#yearID").val(year);

        const csrftoken = document.querySelector(
          "[name=csrfmiddlewaretoken]"
        ).value;
        $("#saveProfile").click(() => {
          $.ajax({
            url: "{% url 'studentProfile' studentprof.studentNumber %}",
            headers: { "X-CSRFToken": csrftoken },
            data: {
              editProfile: 1,
              guardianName: $("#guardianName").val(),
              guardianNum: $("#guardianNumber").val(),
              courseName: $("#courseID").val(),
              yearName: $("#yearID").val(),
              contactD: $("#contactNumber").val(),
            },
            method: "POST",
            success: (data) => {
              $("#editProfileHolderReload").load(
                location.href + " #editProfileHolderReload"
              );
            },
          });
        });

        // edit Profile -----------------------------------------

    

        // Datatable ------------------------
        $("#example").DataTable({
          dom: "Bfrtip",
          buttons: [
            {
              extend: "excelHtml5",
              exportOptions: {
                orthogonal: "export", // Export all rows
                columns: [0, 1, 2, 3], // Include only the first 4 columns
              },
            },
            {
              extend: "pdfHtml5",
              exportOptions: {
                orthogonal: "export", // Export all rows
                columns: [0, 1, 2, 3], // Include only the first 4 columns
              },
            },
          ],
        });
      
        // Datatable ------------------------


        //navigation  ------------------------ ------------------------
        $("#editPage").hide();
        $("#statPage").hide();
        $("#profilePage").hide();
        //end of div that need to hide -----------------

        $("#showProfilePage").click(() => {
          $("#profilePage").show();
          $("#editPage").hide();
          $("#statPage").hide();
          $("#activeEdit").removeClass();
          $("#activeStat").removeClass();
          $("#activeProfile").addClass("active");
        });

        $("#editProfile").click(() => {
          $("#profilePage").hide();
          $("#statPage").hide();
          $("#editPage").show();
          $("#activeProfile").removeClass();
          $("#activeEdit").addClass("active");
          $("#activeStat").removeClass();
        });

        $("#statisticPage").click(() => {
          $("#statPage").show();
          $("#profilePage").hide();
          $("#editPage").hide();
          $("#activeStat").addClass("active");
          $("#activeEdit").removeClass();
          $("#activeProfile").removeClass();
        });

        $("#showProfilePage").click(() => {
          $("#profilePage").show();
          $("#editPage").hide();
          $("#statPage").hide();
          $("#activeEdit").removeClass();
          $("#activeStat").removeClass();
          $("#activeProfile").addClass("active");
        });
        //navigation  ------------------------ ------------------------



        $(".addSubButton").click((e) => {
          $.ajax({
            url: "{% url 'studentProfile' studentprof.studentNumber %}",
            headers: { "X-CSRFToken": csrftoken },
            data: { addSub: e.currentTarget.value },
            method: "POST",
            success: (data) => {
              $("#listOfSubs").load(location.href + " #listOfSubs");
            },
          });
        });
      });

      // function that create bar
      function graph_it_percentage(g, g_width, g_element) {
        let output = '<table border="0" cellspacing="0" cellpadding="8">',
          calwidth_percentage = 0;
        let barColor;

        for (i = 0; i < g.length; i++) {
          calwidth_percentage = g_width * (parseInt(g[i][1]) / 100);

          if (parseInt(g[i][1]) > 75) {
            barColor = "green";
          } else if (parseInt(g[i][1]) < 75 && parseInt(g[i][1]) > 65) {
            barColor = "orange";
          } else {
            barColor = "lightcoral";
          }
          let unfilledBarColor = "lightgrey";
          let unfilledBarWidth = g_width - calwidth_percentage;
          output += `<tr><td style="padding-right: 10px;">${g[i][0]}</td><td><svg xmlns="http://www.w3.org/2000/svg" width="${g_width}" height="10"><g class="bar"><rect x="${calwidth_percentage}" width="${unfilledBarWidth}" height="10" fill="${unfilledBarColor}"></rect><rect width="${calwidth_percentage}" height="10" fill="${barColor}"></rect></g></svg> ${g[i][1]}%</td></tr>`;
        }

        output += "</table>";

        g_element.innerHTML = output;
      }
    </script>
    <script type="text/javascript">
    $(function(){
        $(".btn-toggle-menu").click(function() {
            $("#wrapper").toggleClass("toggled");
        });
    })
    </script>
  </body>
</html>
